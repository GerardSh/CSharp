# General
## Query Basics
### What Are SQL and T-SQL
SQL е декларативен език и е близък до английския език.

Подържа дефинирането, манипулацията и контрола на достъпа до записите.
Почти всичко което е необходимо да направим с базата данни, може да се направи с SQL. 

Transact-SQL (Т-SQL) е версията на Майкрософт за техния SQL Server. 
Всички relational database management systems (RDBMS) имат собствен диалект на SQL, който е създаден с цел решаване на специфични проблеми или да предоставя допълнителна функционалност, която е уникална за съответната система. Голямата част е еднаква и стандартизирана за всички RDBMS.

T-SQL подържа богат набор от ключови думи и оператори, чрез които може да ползваме неща като цикли, условия и тн. Създаден е за да може да пишем логика вътре в базата данни. В края на 90-те е имало разбиране, че най-добрия вариант за създаване на компютърна архитектура е когато бизнес логиката е максимално близко до данните. В резултат на това са се получили трислойни приложения в които програмната част не прави нищо, а е просто интерфейс и цялата бизнес логика е вътре в базата данни. Проблема е че SQL не е най-добрия език за бизнес логика, силата му е в data specific логика, data storage и тн, но не е бизнес език. Поради това, Майкрософт се стараят да направят T-SQL език за бизнес логика. Поддръжката на тези приложения е трудна и трябва да се избягват.
LINQ в C# е опит да се копира SQL, тъй като е много добър в работата с колекции. Чрез LINQ, Microsoft цели да привлече хората работещи с SQL като им предложи нещо познато.
### SQL Examples
```sql
SELECT FirstName, LastName, JobTitle FROM Employees
```

Когато взимаме само част от информацията, без излишните колони се нарича проекция. В примера, взимаме трите посочени колони на всички записи.

```sql
SELECT * FROM Projects WHERE StartDate = '1/1/2006'
```

 Символа * означава че искаме цялата информация. Чрез `WHERE` правим филтрация на записите. В примера, взимаме всички колони на филтрираните записи.

```sql
INSERT INTO Projects(Name, StartDate)
     VALUES ('Introduction to SQL Course', '1/1/2006')
```

Вмъкване данни в базата. Ако ще вмъкваме данни във всички колони, може да пропуснем изреждането им в скобите. Ако сме изредили колоните, трябва в същия ред да подадем данните.

```sql
UPDATE Projects
   SET EndDate = '8/31/2006'
 WHERE StartDate = '1/1/2006'
```

Чрез `UPDATE`, може да променим нещо, което вече е вмъкнато. В примера променяме стойността на `EndDate` колоната в записите, които отговарят на посочения филтър.

```sql
DELETE FROM Projects
      WHERE StartDate = '1/1/2006'
```

Никога не трябва да се трие без `WHERE`, освен ако искаме да изтрием всички записи, но тогава трябва да се ползва `TRUNCATE` защото е много по-бързо, но не може да се използва върху таблици с външни ключове, докато `DELETE` може (стига да се спазят ограниченията). Ако искаме да изтрием цялата таблица, трябва да ползваме `DROP`.
## Retrieving Data Using SELECT
![](Pasted%20image%2020250102164653.png)

При проекцията, искаме само част от данните на записите - взимаме само колоните / пропъртитата на ентитито, които ни интересуват.

При селекцията взимаме точно определени редове / ентитита.

Може да обединим двете неща и да направим проекция и селекция.
### Relational Databases
![](Pasted%20image%2020250102170716.png)

Релациите са връзки между таблиците, които ни позволяват да обединим информацията от две таблици с цел да получим пълното описание за обекта, който ни интересува.
Това се прави с цел дедупликация на данните, намаляване на обема от данни в базата. В MSSMS може да създадем диаграми на връзките / релациите между таблиците, като се създават с десен бутон върху `Database Diagrams` папката, вътре в базата данни.
Примерно ако искаме информация за даден служител и в кой отдел работи, в таблицата със служители, го няма името на отдела защото в един и същи отдел работят много хора и няма смисъл името да се дублира за всеки един от тях. Името се заменя с число, което в таблицата с отдели, кореспондира на определено име. Това е част от нормализацията на базите данни.
### Combining Table Data
Чрез `JOIN` комбинираме информацията от две или повече таблици. Когато в две таблици имаме нещо, което е еднакво, може да го използваме за даги свържем.

```sql
SELECT 
FirstName,
LastName,
Salary,
d.[Name]
FROM Employees AS e JOIN Departments AS d ON e.DepartmentID = d.ManagerID
```

В примера използваме съкращения (alias) за имената на таблиците, което прави кода по-компактен и лесен за четене. Това е често използвана техника в SQL, особено когато се работи с по-дълги или сложни имена на таблици. `JOIN` комбинира редовете от двете таблици (`Employees` и `Departments`) въз основа на условие, зададено в `ON` частта.
В този случай се съпоставят стойностите на `DepartmentID` от таблицата `Employees` с `DepartmentID` от таблицата `Departments`.
Това означава, че всеки служител, на който `DepartmentID` съвпада в двете таблици, ще получи информация за отдела си.

Ако искаме да комбинираме повече от две таблици, трябва да ги изредим една след друга:

```sql
SELECT 
FirstName,
LastName,
Salary,
d.[Name],
a.[AddressText],
t.[Name]
FROM Employees AS e JOIN Departments AS d ON e.DepartmentID = d.ManagerID
JOIN Addresses AS a ON a.AddressID = e.AddressID
JOIN Towns AS t ON t.TownID = a.TownID
```
### Column Aliases
Можем да променяме името на колона в резултата от заявката, като използваме псевдоними. Това е полезно, когато искаме да направим имената на колоните по-ясни или да ги форматираме според изискванията на приложението.
### Concatenation Operator
```sql
SELECT 
CONCAT_WS(' ', FirstName, MiddleName, LastName) AS [Full Name],
CONCAT(FirstName, ' ', MiddleName, ' ', LastName) AS [Full Name],
FirstName + ' ' + LastName AS [Full Name],
EmployeeID
FROM Employees
```

Може да конкатенираме данните, ползвайки оператора `+`, когато говорим за стрингове или функциите `CONCAT(columnName1, ' ', columnName2)` и `CONCAT_WS(separator, columnName1, columnName2)`. `+` оператора е подходящ за основни операции, но не е най-добрият избор, защото не е гъвкав и често води до грешки, ако една от стойностите е `NULL`. Функцията `CONCAT_WS` е най-подходяща, защото ако има запис без `MiddleName` в примера, няма да вкара вторo празно пространство. 

Всички стрингове в SQL и T-SQL са в единични кавички. В стандарта на SQL имената таблиците и обектите са в двойни кавички, но не е задължително. 
Когато искаме да подадем текст, трябва да е в единични кавички.

Имената, съдържащи специални символи като интервал, служебни думи и т.н., трябва да се слагат в квадратни скоби `[ ]` в SQL Server. В допълнение, могат да се използват и двойни кавички `" "`, ако базата данни ги поддържа и настройката `QUOTED_IDENTIFIER` е активирана (в SQL Server обикновено е включена по подразбиране).
### Filtering the Selected Rows
```sql
SELECT DISTINCT DepartmentID
FROM Employees
```

Чрез ключовата дума `DISTINCT` можем да премахнем дублиращите се стойности в резултата на заявка. Това обаче работи само върху колоните, които са включени в `SELECT`. Ако има уникални стойности в някоя от колоните (например `Id`), `DISTINCT` няма да премахне редове, защото целият запис ще бъде уникален.

Може да филтрираме чрез `WHERE`, като израза след `WHERE` трябва да e предикат. Може да се ползват и логическите оператори `NOT`, `OR`, `AND` и скоби за по-голям контрол:

```sql
SELECT LastName, DepartmentID, Salary
FROM Employees
WHERE NOT (DepartmentID = 1) AND (Salary > 40000 OR Salary = 38500)
```

`BETWEEN` оператора се ползва за да се посочи range, като в този range влизат и посочените стойности:

```sql
SELECT LastName, DepartmentID, Salary
FROM Employees
WHERE Salary BETWEEN 20000 AND 40000
```

`IN` / `NOT IN` операторите се ползват за филтриране по група от стойности, като това най-често са Id-та:

```sql
SELECT LastName, DepartmentID, Salary
FROM Employees
WHERE ManagerID IN (109, 3, 16)
```
# Misc
Когато пишем `SELECT` заявки е добре да пишем първо `FROM` и името на таблицата, защото така ще ни подсказва чрез IntelliSense.
# ChatGPT
# Bookmarks
Цompletion: 03.01.2025